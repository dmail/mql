<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lifebar</title>
  </head>
  <body>
    <div id="root" style="position: relative"></div>
    <style>
      * {
        box-sizing: border-box;
      }
    </style>
    <script type="module" jsenv-type="module/jsx">
      /* eslint-disable no-unused-vars */
      import { render } from "preact";
      import { useState } from "preact/hooks";

      const App = () => {
        const [value, valueSetter] = useState(25);
        const [max, maxSetter] = useState(40);

        return (
          <div style="display: flex;">
            <div style="display: flex; width: 200px;  justify-content: center; flex-direction: column">
              <fieldset>
                <legend>6/40 PV</legend>
                <LifebarUI value={6} max={40} />
              </fieldset>
              <fieldset>
                <legend>86/130 PV</legend>
                <LifebarUI value={86} max={130} />
              </fieldset>
              <fieldset>
                <legend>860/1300 PV</legend>
                <LifebarUI value={860} max={1300} />
              </fieldset>
            </div>
            <div>
              <fieldset>
                <legend>Interactive</legend>
                <LifebarUI value={value} max={max} />
                <label>
                  Vie:&nbsp;
                  <input
                    type="number"
                    value={value}
                    onChange={(event) => {
                      valueSetter(event.target.value);
                    }}
                  />
                </label>
                <br />
                <label>
                  Vie max:&nbsp;
                  <input
                    type="number"
                    value={max}
                    onChange={(event) => {
                      maxSetter(event.target.value);
                    }}
                  />
                </label>
              </fieldset>
            </div>
          </div>
        );
      };

      const LifebarUI = (props) => {
        return (
          <div style="width: 150px; height: 40px; background: black; border: 2px solid yellow;">
            <div style="width: 120px; height: 20px; margin-top: 2px; margin-left: 2px;">
              <Lifebar {...props} />
            </div>
          </div>
        );
      };

      const Lifebar = ({
        value,
        max,
        fullColor = "yellow",
        emptyColor = "red",
      }) => {
        if (max <= 40) {
          return (
            <LifebarBelow40
              value={value}
              max={max}
              fullColor={fullColor}
              emptyColor={emptyColor}
            />
          );
        }
        const maxLifePoint = 20 * 40; // 800
        if (max <= maxLifePoint) {
          return (
            <LifebarBelow800
              value={value}
              max={max}
              fullColor={fullColor}
              emptyColor={emptyColor}
            />
          );
        }
        return (
          <LifebarBelow1600
            value={value}
            max={max}
            fullColor={fullColor}
            emptyColor={emptyColor}
          />
        );
      };

      const LifebarSvg = ({
        barWidth,
        bars,
        maxBars,
        barSpacing = 1,
        emptyColor,
        fullColor,
      }) => {
        const totalWidth = maxBars * (barWidth + barSpacing);

        return (
          <svg
            viewBox={`0 0 ${totalWidth} 100`}
            xmlns="http://www.w3.org/2000/svg"
            preserveAspectRatio="none"
            width="100%"
            height="100%"
            style="display: block"
          >
            <g>
              {bars.map((bar, index) => {
                const x = index * (barWidth + barSpacing);
                return (
                  <rect
                    key={index}
                    name={`life_${bar.from}:${bar.to}`}
                    x={x}
                    y="0"
                    width={barWidth}
                    height="100"
                    fill={bar.filled ? fullColor : emptyColor}
                  ></rect>
                );
              })}
            </g>
          </svg>
        );
      };

      const createBars = ({ value, start, end, step }) => {
        const bars = [];
        let life = start;
        while (life <= end) {
          const from = life;
          const to = life + step;
          bars.push({
            from,
            to,
            filled: to < value,
          });
          life = to;
        }
        return bars;
      };

      const LifebarBelow40 = ({ value, max, emptyColor, fullColor }) => {
        const bars = createBars({ value, start: 0, end: max, step: 1 });
        return (
          <LifebarSvg
            bars={bars}
            barWidth={2}
            maxBars={40}
            emptyColor={emptyColor}
            fullColor={fullColor}
          />
        );
      };

      const LifebarBelow800 = ({ value, max, emptyColor, fullColor }) => {
        const barsForLifeBetween40And800 = createBars({
          value,
          start: 41,
          end: max,
          step: 40,
        });
        const barsForRemainingLife = createBars({
          value,
          start: 0,
          end: 40,
          step: 1,
        });

        return (
          <div style="display: flex; flex-direction: column; width: 100%; height: 100%">
            <div style="height: 70%">
              <LifebarSvg
                bars={barsForRemainingLife}
                barWidth={2}
                maxBars={40}
                emptyColor={emptyColor}
                fullColor={fullColor}
              />
            </div>
            <div style="height: 30%; padding-top: 1px">
              <div style="height: 100%">
                <LifebarSvg
                  bars={barsForLifeBetween40And800}
                  barWidth={5}
                  maxBars={20}
                  emptyColor={emptyColor}
                  fullColor={fullColor}
                />
              </div>
            </div>
          </div>
        );
      };

      const LifebarBelow1600 = ({ value, max, emptyColor, fullColor }) => {
        const barsForLifeBetween40And800 = createBars({
          value,
          start: 41,
          end: 800,
          step: 40,
        });
        const barForLifeBetween800And1600 = createBars({
          value,
          start: 801,
          end: max - 801,
          step: 40,
        });
        const barsForRemainingLife = createBars({
          value,
          start: 0,
          end: 40,
          step: 1,
        });

        return (
          <div style="display: flex; flex-direction: column; width: 100%; height: 100%">
            <div style="height: 30%">
              <LifebarBelow40
                bars={barsForRemainingLife}
                barWidth={2}
                maxBars={40}
                emptyColor={emptyColor}
                fullColor={fullColor}
              />
            </div>
            <div style="height: 60%;">
              <div style="height: 50%; padding-top: 1px">
                <div style="height: 100%">
                  <LifebarSvg
                    bars={barsForLifeBetween40And800}
                    barWidth={5}
                    maxBars={20}
                    emptyColor={emptyColor}
                    fullColor={fullColor}
                  />
                </div>
              </div>
              <div style="height: 50%; padding-top: 1px">
                <div style="height: 100%">
                  <LifebarSvg
                    bars={barForLifeBetween800And1600}
                    barWidth={5}
                    maxBars={20}
                    emptyColor={emptyColor}
                    fullColor={fullColor}
                  />
                </div>
              </div>
            </div>
          </div>
        );
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
