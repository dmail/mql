<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Draw corner</title>
  </head>
  <body>
    <div id="root" style="position: relative"></div>
    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { useRef, useLayoutEffect } from "preact/hooks";
      import { useLocalStorageState } from "/app/hooks/use_local_storage_state.js";

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        const canvasRef = useRef();
        const [x, xSetter] = useLocalStorageState("x", 50);
        const [y, ySetter] = useLocalStorageState("y", 25);
        const [width, widthSetter] = useLocalStorageState("width", 50);
        const [height, heightSetter] = useLocalStorageState("height", 50);
        const [size, sizeSetter] = useLocalStorageState("size", 1);
        const [radius, radiusSetter] = useLocalStorageState("radius", 10);

        useLayoutEffect(() => {
          const canvas = canvasRef.current;
          const context = canvas.getContext("2d");
          context.clearRect(0, 0, canvas.width, canvas.height);

          drawTopLeftCorner(context, {
            x,
            y,
            width,
            height,
            size,
            radius,
            color: "blue",
          });
          drawTopLeftCorner(context, {
            x: x + size,
            y: y + size,
            width: width - size,
            height: height - size,
            size,
            radius: 0,
            controlPoint: [17, 17],
            color: "green",
          });

          drawTopRightCorner(context, {
            x: x + 100,
            y,
            width,
            height,
            size,
            radius,

            color: "red",
          });
        }, [x, y, width, height, size, radius]);

        return (
          <div>
            <canvas ref={canvasRef} width="100" height="100"></canvas>
            <fieldset>
              <legend>Options</legend>

              <label>
                x:
                <input
                  type="number"
                  min="0"
                  max="100"
                  value={x}
                  onInput={(e) => xSetter(e.target.valueAsNumber)}
                />
              </label>
              <label>
                y:
                <input
                  type="number"
                  min="0"
                  max="100"
                  value={y}
                  onInput={(e) => ySetter(e.target.valueAsNumber)}
                />
              </label>
              <br />
              <label>
                width:
                <input
                  type="number"
                  min="1"
                  max="100"
                  value={width}
                  onInput={(e) => widthSetter(e.target.valueAsNumber)}
                />
              </label>
              <label>
                height:
                <input
                  type="number"
                  min="1"
                  max="100"
                  value={height}
                  onInput={(e) => heightSetter(e.target.valueAsNumber)}
                />
              </label>
              <br />
              <label>
                border size:
                <input
                  type="number"
                  min="1"
                  max="100"
                  value={size}
                  onInput={(e) => sizeSetter(e.target.valueAsNumber)}
                />
              </label>
              <label>
                border radius:
                <input
                  type="number"
                  min="1"
                  max="100"
                  value={radius}
                  onInput={(e) => radiusSetter(e.target.valueAsNumber)}
                />
              </label>
            </fieldset>
          </div>
        );
      };

      const drawTopLeftCorner = (
        context,
        {
          x,
          y,
          width,
          height,
          size,
          radius,
          color,
          controlPoint = [x + size / 2, y + size / 2],
        },
      ) => {
        context.lineWidth = size;
        const leftLineStart = [x + size / 2, y + size + radius];
        const leftLineEnd = [x + size / 2, y + height];
        const topLineStart = [x + radius + size, y + size / 2];
        const topLineEnd = [x + width, y + size / 2];
        if (leftLineStart[1] < leftLineEnd[1]) {
          drawLine(context, leftLineStart, leftLineEnd, { color });
        }
        drawQuadraticCurveTo(
          context,
          leftLineStart,
          controlPoint,
          topLineStart,
          { color },
        );
        if (topLineStart[0] < topLineEnd[0]) {
          drawLine(context, topLineStart, topLineEnd, { color });
        }
      };

      const drawTopRightCorner = (
        context,
        { x, y, width, height, size, radius, color },
      ) => {
        context.lineWidth = size;

        const topLineXStart = x - width;
        const topLineXEnd = topLineXStart + width - radius - size;
        const topLineY = y + size / 2;
        const rightLineX = x - size / 2;
        const rightLineYStart = y + radius + size;
        const rightLineYEnd = rightLineYStart + height - radius - size;
        const topLineStart = [topLineXStart, topLineY];
        const topLineEnd = [topLineXEnd, topLineY];
        const rightLineStart = [rightLineX, rightLineYStart];
        const rightLineEnd = [rightLineX, rightLineYEnd];
        if (topLineStart[0] < topLineEnd[0]) {
          drawLine(context, topLineStart, topLineEnd, { color });
        }
        const controlPoint = [x - size / 2, y + size / 2];
        drawQuadraticCurveTo(
          context,
          topLineEnd,
          controlPoint,
          rightLineStart,
          {
            color,
          },
        );
        if (rightLineStart[1] < rightLineEnd[1]) {
          drawLine(context, rightLineStart, rightLineEnd, { color });
        }
      };

      const drawPoint = (context, [x, y], { color = "violet" } = {}) => {
        context.beginPath();
        context.arc(x, y, 2, 0, Math.PI * 2);
        context.fillStyle = color;
        context.fill();
      };
      const drawLine = (context, start, end, { color = "red" } = {}) => {
        context.beginPath();
        context.moveTo(start[0], start[1]);
        context.lineTo(end[0], end[1]);
        context.strokeStyle = color;
        context.stroke();
        drawPoint(context, start, { color: "aqua" });
        drawPoint(context, end, { color: "chocolate" });
      };
      //   const drawBezierCurveTo = (
      //     context,
      //     start,
      //     controlPoint,
      //     secondControlPoint,
      //     end,
      //     { color = "green" } = {},
      //   ) => {
      //     context.beginPath();
      //     context.moveTo(start[0], start[1]);
      //     context.bezierCurveTo(
      //       controlPoint[0],
      //       controlPoint[1],
      //       secondControlPoint[0],
      //       secondControlPoint[1],
      //       end[0],
      //       end[1],
      //     );
      //     context.strokeStyle = color;
      //     context.stroke();
      //     drawPoint(context, controlPoint, { color: "orange" });
      //     drawPoint(context, secondControlPoint, { color: "yellow" });
      //   };
      const drawQuadraticCurveTo = (
        context,
        start,
        controlPoint,
        endPoint,
        { color = "darkgreen" } = {},
      ) => {
        context.beginPath();
        context.moveTo(start[0], start[1]);
        context.quadraticCurveTo(
          controlPoint[0],
          controlPoint[1],
          endPoint[0],
          endPoint[1],
        );
        context.strokeStyle = color;
        context.stroke();
        drawPoint(context, start, { color: "chartreuse" });
        drawPoint(context, controlPoint, { color: "orange" });
        drawPoint(context, endPoint, { color: "chartreuse" });
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
