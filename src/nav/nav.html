<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Curtain test</title>
  </head>
  <body>
    <div id="root" style="position: relative"></div>
    <img src="/__delayed__.js" />

    <script type="module" jsenv-type="module/jsx">
      /*
TODO: 

- show a button to resolve pageA promise to see if it works

- get a way to get route data if any (result of the load function)
I think useRoute should be split into
 - useRouteIsLoading
 - useRouteLoadingIsAborted
 - useRouteLoadError
 - useRouteLoadedData
- for route with dynamic params, a way to get the current param (but I bet getting it from url
remains the better solution)

- test with pageA and pageB being in the url pathname
 (requires to update jsenv)

- test how cancellation is propagated 
test with an api accepting abort signal
whatever may reject a promise when an abort signal is triggered

*/

      import { render } from "preact";
      import {
        useUrl,
        registerRoutes,
        useRoute,
        useCanGoBack,
        useCanGoForward,
        goBack,
        goForward,
        reload,
        useNavigationReadyState,
        useCanStopNavigation,
        stopNavigation,
        useUrlBooleanParam,
        useUrlStringParam,
      } from "./nav.js";

      let resolveNavigationToPageA;
      const { pageA, pageB } = registerRoutes({
        pageA: {
          test: ({ searchParams }) => {
            return searchParams.get("page") === "A";
          },
          load: async () => {
            await new Promise((resolve) => {
              resolveNavigationToPageA = resolve;
            });
          },
        },
        pageB: {
          test: ({ searchParams }) => {
            return searchParams.get("page") === "B";
          },
        },
        fallback: {
          load: () => {
            console.log("load fallback");
          },
        },
      });

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        const url = useUrl();
        const [opened, openDetails, closeDetails] =
          useUrlBooleanParam("opened");
        const [page, pageSetter] = useUrlStringParam("page");

        return (
          <div>
            <div>url: {url}</div>

            <button
              onClick={async () => {
                await window.fetch("/__delayed__.js", { method: "POST" });
              }}
            >
              let window "load" occur
            </button>

            <NavControls />

            <details
              open={opened}
              onToggle={(toggleEvent) => {
                if (toggleEvent.newState === "open") {
                  openDetails();
                } else {
                  closeDetails();
                }
              }}
            >
              <summary>Details summary</summary>
              Details content
            </details>

            <div>
              <div>
                <button
                  disabled={page === "A"}
                  onClick={() => {
                    pageSetter("A");
                  }}
                >
                  A
                </button>
                <button
                  disabled={page === "B"}
                  onClick={() => {
                    pageSetter("B");
                  }}
                >
                  B
                </button>
              </div>
            </div>

            <div>
              <div>PAGE CONTENT</div>
              <div style="border: 1px solid black; padding: 10px">
                {page === "A" ? (
                  <PageA />
                ) : page === "B" ? (
                  <PageB />
                ) : (
                  "nothing"
                )}
              </div>
            </div>
          </div>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const NavControls = () => {
        const canGoBack = useCanGoBack();
        const canGoForward = useCanGoForward();
        const navReadyState = useNavigationReadyState();
        const canStopNavigation = useCanStopNavigation();

        return (
          <fieldset>
            <legend>nav controls (or use browser controls)</legend>

            <div>nav state: {navReadyState}</div>

            <button
              disabled={!canStopNavigation}
              onClick={() => {
                stopNavigation();
              }}
            >
              Stop
            </button>
            <button
              disabled={!canGoBack}
              onClick={() => {
                goBack();
              }}
            >
              back
            </button>
            <button
              disabled={!canGoForward}
              onClick={() => {
                goForward();
              }}
            >
              forward
            </button>
            <button
              onClick={() => {
                reload();
              }}
            >
              reload
            </button>
          </fieldset>
        );
      };

      // eslint-disable-next-line no-unused-vars
      const PageA = () => {
        const [isLoading, isAborted] = useRoute(pageA);
        if (isLoading) {
          return "page A loading...";
        }
        if (isAborted) {
          return `page A load aborted`;
        }
        return "page A content";
      };

      // eslint-disable-next-line no-unused-vars
      const PageB = () => {
        const [isLoading, isAborted] = useRoute(pageB);
        if (isLoading) {
          return "page B loading...";
        }
        if (isAborted) {
          return `page B load aborted`;
        }
        return "page B content";
      };

      render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
