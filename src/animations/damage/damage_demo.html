<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Damage demo</title>
  </head>
  <body>
    <div
      id="animated_el"
      style="width: 200px; height: 50px; background: green"
    ></div>
    <div id="root"></div>
    <script type="module" jsenv-type="module/jsx">
      import { render } from "preact";
      import { signal, computed } from "@preact/signals";
      import { animateDamageDisplay } from "./damage.js";
      import {
        pauseAllAnimations,
        playAllAnimations,
        useAnimationsAllPaused,
      } from "../animation_signal.js";

      let hasAutopaused = false;
      const animation = animateDamageDisplay(
        document.querySelector("#animated_el"),
        {
          duration: 1000,
          autoplay: false,
          onfinish: () => {
            hasAutopaused = false;
          },
        },
      );
      const stateSignal = animation.stateSignal;
      const canPlaySignal = computed(() => {
        return (
          stateSignal.value === "idle" ||
          stateSignal.value === "finished" ||
          stateSignal.value === "paused"
        );
      });
      const canPauseSignal = computed(() => {
        return stateSignal.value === "running";
      });
      const autopauseMsSignal = signal(300);
      const autopauseChecked = signal(false);

      const play = () => {
        animation.play();
        if (!hasAutopaused && autopauseChecked.peek()) {
          setTimeout(() => {
            hasAutopaused = true;
            pauseAllAnimations();
          }, autopauseMsSignal.peek());
        }
      };
      const pause = () => {
        hasAutopaused = false;
        animation.pause();
      };

      // eslint-disable-next-line no-unused-vars
      const App = () => {
        const allPaused = useAnimationsAllPaused();

        return (
          <div>
            <div></div>

            <fieldset>
              <legend>Controls</legend>

              <button disabled={!canPlaySignal.value} onClick={play}>
                Play
              </button>
              <button disabled={!canPauseSignal.value} onClick={pause}>
                Pause
              </button>

              <br />
              <button disabled={allPaused} onClick={pauseAllAnimations}>
                Pause all
              </button>
              <button disabled={!allPaused} onClick={playAllAnimations}>
                Play all
              </button>
              <label>
                <input
                  type="checkbox"
                  checked={autopauseChecked.value}
                  onChange={(e) => {
                    autopauseChecked.value = e.target.checked;
                  }}
                />
                Autopause
              </label>
              <input
                type="number"
                value={autopauseMsSignal.value}
                step="10"
                min="10"
                max="1000"
              />
            </fieldset>

            <div>
              <div>state: {stateSignal.value}</div>
            </div>
          </div>
        );
      };

      render(<App />, document.querySelector("#root"));
    </script>
  </body>
</html>
